
<!DOCTYPE html>
<html lang="en_us">
    <head>
                <title>Scratching My Head Again</title>
            <meta charset="utf-8" />
            <meta name="generator" content="Pelican" />
            <meta name="viewport" content="width=device-width, initial-scale=1.0" />
            <link rel="stylesheet" href="/static/css/main.css" />
            <link rel="stylesheet" href="/static/css/theme.css" />
                    <link rel="icon" href="/images/yazani/yazani_1_extracted_bg_big_eyes_cropped.png" type="image/png" />
                    <link rel="apple-touch-icon" href="/images/yazani/yazani_1_extracted_bg_big_eyes_cropped.png" type="image/png" />
                        <script src="/static/misc.js"></script>



    


        <meta name="tags" content="programming, c" />
    <meta property="og:site_name" content="dragoncoder047&rsquo;s blog" />
    <meta property="og:title" content="Scratching My Head Again" />
    <meta property="og:description" content="Again I find myself scratching my head over a simple scripting language. Yisp (my attempt at re-writing David Johnson-Davies’ uLisp) got way too complicated; tinyTcl (my attempt a re-writing Serge Zaitsev’s ParTcl) leaked memory like a sieve; and MicroPython can’t be extended with custom functions. All I want …" />
    <meta property="og:image" content="/images/yazani/yazani_1_extracted_bg.png" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://dragoncoder047.github.io/blog/2022/scratching-my-head-again" />
    <meta property="og:locale" content="['']" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="dragoncoder047&rsquo;s blog - Scratching My Head Again" />
    <meta name="twitter:description" content="Again I find myself scratching my head over a simple scripting language. Yisp (my attempt at re-writing David Johnson-Davies’ uLisp) got way too complicated; tinyTcl (my attempt a re-writing Serge Zaitsev’s ParTcl) leaked memory like a sieve; and MicroPython can’t be extended with custom functions. All I want …" />
    <meta name="twitter:image" content="/images/yazani/yazani_1_extracted_bg.png" />
            <!-- PrismJS -->
<script src="/static/prism.js" data-autoloader-path="https://cdn.jsdelivr.net/npm/prismjs@v1.x/components/"></script>
<script src="/static/prism-runbutton.js"></script>
<script src="/phoo/prism-phoo.js"></script>        <!-- /PrismJS -->







    </head>

    <body class="match-braces rainbow-braces">
        <header>
                <a href="https://dragoncoder047.github.io/blog" class="flex-row"><div class="flex-row"><img src="/images/yazani/yazani_1_extracted_bg.png" style="max-height:10em" id="banner-image" /><div id="sitename-text"><h1>dragoncoder047&rsquo;s blog</h1><h2>random thoughts about nonrandom things</h2></div></div></a>
            <nav>
                <ul>
                    <li><a href="https://dragoncoder047.github.io/blog/">Home</a></li>
                        <li><a href="https://dragoncoder047.github.io/blog/archives">Archives</a>
                        </li>
                        <li><a href="https://dragoncoder047.github.io/blog/tags">By tag</a>
                        </li>
                        <li><a href="/">Site root</a>
                        </li>
                        <li><a href="#">Projects</a>
                                <ul>
                                                            <li><a href="https://dragoncoder047.github.io/thuepaste">Thuepaste</a>
                        </li>
                        <li><a href="https://dragoncoder047.github.io/armdroid">Armdroid</a>
                        </li>
                        <li><a href="https://dragoncoder047.github.io/langton-music">Langton's Ant Music</a>
                        </li>
                        <li><a href="https://dragoncoder047.github.io/schemascii">Schemascii</a>
                        </li>
                        <li><a href="https://dragoncoder047.github.io/parasite">Parasite</a>
                        </li>

                                </ul>
                        </li>
                    <li>
                        <form action="https://www.google.com/search" method="GET">
                            <input name="q" type="search" placeholder="Search"></input>
                            <input type="hidden" name="as_sitesearch" value="https://dragoncoder047.github.io/blog"></input>
                            <input type="submit" value="Search"></input>
                        </form>
                    </li>
                </ul>
            </nav>
        </header>
        <main>
    <h1><a href="https://dragoncoder047.github.io/blog/2022/scratching-my-head-again" rel="bookmark" title="Permalink to this page">Scratching My Head Again</a></h1>
    
    <div class="flex-row">
            <span style="flex: 1">&larr; Previous:
                <a href="https://dragoncoder047.github.io/blog/2022/partcl">
                    ParTcl
                </a>
            </span>
            <span>Next:
                <a href="https://dragoncoder047.github.io/blog/2022/some-unrelated-ideas">
                    Some Unrelated Ideas
                </a> &rarr;
            </span>
    </div>
    <div class="post-info">
        Posted <time class="published" datetime="2022-10-19T00:00:00-04:00">Wed 19 October 2022</time>
            <address>By
                    <a href="https://dragoncoder047.github.io/blog/">dragoncoder047</a>
            </address>
            <div class="tags">
                Tags:
                    <a href="https://dragoncoder047.github.io/blog/tag/c">c</a>
                    <a href="https://dragoncoder047.github.io/blog/tag/programming">programming</a>
            </div>
    </div>
        <p><em>This post is part 3 of the arduino-scripting series:</em></p>
        <ol class="series">
                <li >
                    <a href='https://dragoncoder047.github.io/blog/2022/ulisp-thoughts'>uLisp Thoughts</a>
                </li>
                <li >
                    <a href='https://dragoncoder047.github.io/blog/2022/partcl'>ParTcl</a>
                </li>
                <li class="active">
                    <a href='https://dragoncoder047.github.io/blog/2022/scratching-my-head-again'>Scratching My Head Again</a>
                </li>
                <li >
                    <a href='https://dragoncoder047.github.io/blog/2022/some-unrelated-ideas'>Some Unrelated Ideas</a>
                </li>
                <li >
                    <a href='https://dragoncoder047.github.io/blog/2022/segfaults'>Segfaults</a>
                </li>
                <li >
                    <a href='https://dragoncoder047.github.io/blog/2023/lilduino'>LILduino</a>
                </li>
        </ol>
    <p>Again I find myself scratching my head over a simple scripting language. <a href="https://github.com/dragoncoder047/yisp">Yisp</a> (my attempt at re-writing David Johnson-Davies&rsquo; uLisp) got way too complicated; <a href="https://github.com/dragoncoder047/tinytcl">tinyTcl</a> (my attempt a re-writing Serge Zaitsev&rsquo;s ParTcl) leaked memory like a sieve; and <a href="https://micropython.org">MicroPython</a> can&rsquo;t be extended with custom functions. All I want to do is have a scripting engine for my ESP32 that can run scripts off an SD card!! Argh!! Obviously, I can&rsquo;t think like a C programmer should.</p>
<p>I can&rsquo;t ignore the previous experience that I had with those languages (minus MicroPython, of course, I never even tried). I learned how to make a dynamically typed object; I learned how to parse the source code recursively; I learned how to do tail-call optimization; I learned how to use a linked list; and I learned how a mark-and-sweep garbage collector works. And my experience writing <a href="https://github.com/phoo-lang/phoo">Phoo</a> should help with making a concatenative language as well.</p>
<h2 id="lisp-like-languages">Lisp-like languages</h2>
<p>Yisp (at least the part that I implemented), as well as any Lisp, represent all objects as <code>cons</code> cells. <a href="http://www.ulisp.com">uLisp</a>, or at least the 32-bit implementation of it, packed each cell into 64 bits. The top 32 bits are a pointer to the <code>car</code> cell, and the bottom 32 point to the <code>cdr</code>. Now, of course, even though <em>technically</em> you can implement everything in Lisp using <code class="language-lisp highlight">cons</code> and <code class="language-lisp highlight">nil</code>, it saves memory greatly if there are also primitives such as numbers, symbols, strings, characters, arrays, etc. And all of the objects must have some place to mark them for the garbage collector.</p>
<p>uLisp takes advantage of the fact that a valid pointer will always be aligned to even byte boundaries, so the low bit will always be 0. This is set as the &ldquo;mark bit&rdquo; for the garbage collector. The other types are identified by a specific low pointer in the <code>car</code> half, which would normally point to an invalid address. For example, a <code>SYMBOL</code> contains <code class="language-c highlight">0x00000002</code> for the <code>car</code> pointer, an <code>INTEGER</code> contains <code class="language-c highlight">0x00000006</code>, and  a <code>STRING</code> contains <code class="language-c highlight">0x00000100</code>, for example. Structures that can&rsquo;t be represented as one single cell (i.e. strings, arrays, long symbols) are represented as a chunk of the value in one field and a pointer to the next chunk in the other field.</p>
<p>uLisp&rsquo;s memory allocation scheme is a little weird, admittedly. uLisp begins by statically allocating a huge (~10,000 item) array of empty cells, and then running up from the far end, setting the pointers of each cell to make a large linked list containing all of the free cells; this is called the <code>Freelist</code>. When a new object is needed the pointer to the <code>Freelist</code> is updated to the second cell in the <code>Freelist</code>, and the first one is returned to be used. During the sweep phase of grabage collection, the <code>Freelist</code> is simply re-constructed using the unmarked cells &ndash; and at the beginning, everything&rsquo;s unmarked, so this is effectively the same action. It skips over the marked cells.</p>
<p>uLisp &ndash; unlike many other Lisps &ndash; also implements tail-call elimination, which saves an entry on the call stack when a function ends by immediately returning the call of another function. The way this is done is any forms which do an &ldquo;implicit <code class="language-lisp highlight">progn</code>&rdquo;, instead of evaluating the last statement in the <code class="language-lisp highlight">progn</code>, they simply return it unevaluated, and then signal to <code class="language-lisp highlight">eval</code> that the returned form should be evaluated again. For example, consider the factorial function:</p>
<pre class="highlight"><code class="language-lisp">(defun factorial (x) (if (&lt; 0 x) 1 (factorial (1- x))))</code></pre>
<p><code class="language-lisp highlight">if</code> supports tail-call elimination, and so does the &ldquo;implicit <code class="language-lisp highlight">progn</code>&rdquo; performed by the function body. Normally, if the stack limit was X, trying to get the factorial of anything greater than X would overflow the C call stack. The way <code class="language-lisp highlight">if</code> eliminates that looks like this:</p>
<p>Without tail recursion:</p>
<pre class="highlight"><code class="language-txt">eval(factorial(5))
                  --calls--&gt;
                            fn_if()
                                   --calls--&gt;
                                             eval(factorial(4))
                                                               --&gt; and so on until the stack overflows
</code></pre>
<p>With tail recursion:</p>
<pre class="highlight"><code class="language-txt">eval(factorial(5))
                  --calls--&gt;
                            fn_if()
                  &lt;--returns next call to factorial(4)--
eval(factorial(4))
                  --calls--&gt;
                            fn_if()
                  &lt;--returns next call to factorial(3)--
--&gt; and so on, the stack never needing more than 2 entries</code></pre>
<p>The neat part about this is the compiler doesn&rsquo;t need to &ldquo;guess&rdquo; when it needs to eliminate a tail-call. Because, by definition, tail-call elimination applies <em>only when a function ends by immediately returning the call of another function</em>, when it evaluates a block of code, it can evaluate everything <em>except</em> the last call, and instead return the last line to be evaluated <em>after</em> the C call frame is removed from the stack. Neato!</p>
<h2 id="tcl">Tcl</h2>
<p>Tcl&rsquo;s mantra is &ldquo;Everything Is A String.&rdquo; Each line (terminated by a newline or semicolon) is one command. To evaluate a line, the line is split into tokens. Then the procedure named by the first token is called with the rest of the tokens as arguments. Consider how the <code>if-else</code> statement works in Tcl:</p>
<pre class="highlight"><code class="language-tcl">if {condition} {
    # true code here
} else {
    # false code here
}</code></pre>
<p>This isn&rsquo;t some special compiler construct; because the braces trigger the tokenizer to group everything inside of it as one literal (escaped) string, Tcl treats that snippet as <em>one line</em>. When the <code class="language-tcl highlight">if</code> procedure is called, it <code class="language-tcl highlight">eval</code>&lsquo;s the condition, and if it is true, it <code class="language-tcl highlight">eval</code>&lsquo;s the true block, otherwise it <code class="language-tcl highlight">eval</code>&lsquo;s the false block. In Tcl, valid code is represented no differently than a raw string.</p>
<p>The tiny implementation of Tcl I found &ndash; <a href="https://github.com/zserge/partcl">ParTcl</a> &ndash; takes the Everything Is A String mantra to the extreme, <code class="language-c highlight">sprintf()</code>&lsquo;ing numbers back to strings after arithmetic is done on them and (in my opinion) wasting precious memory. It stores <em>everything</em> &ndash; strings, commands, numbers, lists, you name it &ndash; as C <code class="language-c highlight">char*</code> strings delimited in the same way as commands. To access an item of a list, it <code class="language-c highlight">malloc()</code>&lsquo;s enough memory and then <em>copies</em> the chunk of that string representing the requested item into a new string. When you&rsquo;re done with it, you can <code class="language-c highlight">free()</code> the string withut having to worry about corrupting where you got it from. (I did; perhaps that&rsquo;s why my extensions have memory leaks.)</p>
<p>The memory management strategy of ParTcl could probably be called the &ldquo;No-GC&rdquo; approach to GC: instead of having one object with multiple pointers to it, you have multiple identical objects that each only ever have one pointer to them (i.e. the C variable). Because each object is only ever pointed to in one place, and the VM knows what it&rsquo;s doing with each object and when it&rsquo;s done with them, it also knows when to <code class="language-c highlight">free()</code> each object. This, unfortunately, means that objects are inherently immutable, and wastes memory making copies of objects.</p>
<p>ParTcl&rsquo;s approach to variables, however, looks a lot like &hellip; drumroll please &hellip; Lisp! The ParTcl VM maintains a pointer to a linked list of all the global variables, and each variable cell contains a pointer to the next variable cell, its name (a string), and its value (another string). The <code class="language-tcl highlight">set</code> command mutates these pointers.</p>
<p>Tcl also has an interesting approach to return values. Each procedure, instead of returning a value, instead sets it on the Tcl VM&rsquo;s <code>result</code> field, and returns instead one of the standard Tcl &ldquo;return codes&rdquo; which are numbers, not strings &ndash; one of <code>TCL_OK</code> for a normal call, <code>TCL_ERROR</code> if something went wrong (and then the <code>result</code> field is an error message), <code>TCL_RETURN</code> which is returned by the <code class="language-tcl highlight">return</code> command to signal that a procedure is returning and subsequent commands should be skipped, and <code>TCL_BREAK</code> / <code>TCL_AGAIN</code> which are returned by the <code class="language-tcl highlight">break</code> and <code class="language-tcl highlight">continue</code> commands to signal to loops that the appropriate action should be taken.</p>
<h2 id="other-thoughts">Other Thoughts</h2>
<p>In trying to find more information about a scripting language for Arduino I discovered several helpful resources pertaining to building a scripting language itself (which is what I&rsquo;ll have to do if I can&rsquo;t find anything suitable).</p>
<p>First up is Bob Nystrom&rsquo;s blog post <a href="http://journal.stuffwithstuff.com/2013/12/08/babys-first-garbage-collector/">&ldquo;Baby&rsquo;s First Garbage Collector&rdquo;</a> and <a href="https://github.com/munificent/mark-sweep/">its code</a>.</p>
<p>I&rsquo;ll note here that while I was playing around with uLisp, I came up with an idea of how to eliminate the need for a huge statically allocated array that you have to play around with the size of until it fills <em>just enough</em> RAM but not <em>too much</em>. The idea I came up with was the reverse of the <code>Freelist</code> idea: a <code>Usedlist</code> of sorts, where whenever an object is allocated, another &ldquo;shadow&rdquo; object is allocated alongside it and linked into the <code>Usedlist</code> to be able to point to the object that was allocated. The downside of this scheme is it uses double the memory (one cell for the object, another cell for the <code>Usedlist</code> entry).</p>
<p>Bob&rsquo;s garbage collector takes pretty much same approach to garbage collection as uLisp &ndash; in that you maintain a list of &ldquo;all objects&rdquo; (using the large array, or a <code>Usedlist</code>), recursively mark everything, and then free the unmarked objects. Bob&rsquo;s collector differs from uLisp in that the &ldquo;all objects&rdquo; list is formed by the objects themselves: as well as slots to hold the <code>car</code> and <code>cdr</code> pointers (or whatever else data they need to store) there is another slot, inaccessible from inside the scripting language, that always points to the previous object that was allocated. That way, the garbage collector can run through these pointers, ignoring all the data in the rest of the object, and when it gets to an unmarked object, splice it out of the list and <code class="language-c highlight">free()</code> it. The disadvantage is objects take up more memory, running the risk the objects won&rsquo;t be an &ldquo;nice&rdquo; number of bytes, and so <code class="language-c highlight">malloc()</code> will leave &ldquo;holes&rdquo; in the heap and waste memory.</p>
<p>The next thing is a technique known as <strong>NaN-boxing</strong>.</p>
<p>Most computers represent floating-point numbers (i.e. non-integers) according to the IEEE 754 standard. The 64 bits of a C <code class="language-c highlight">double</code> are split into 1 sign bit, 11 exponent bits, and 52 fraction bits. When you divide by zero (or any other operation that would result in a mathematically undefined value) the operation returns (in hexadecimal) <code class="language-c highlight">0xFFF8000000000000</code>. But only the top 13 bits (<code class="language-c highlight">0xFFF8...</code>) must be set to make it a NaN value, so the other 51 can be used for anything you like &ndash; storing a pointer, an integer, a singleton ID, etc. And, of course, doubles.</p>
<p><a href="https://github.com/zuiderkwast/nanbox/">Viktor S&ouml;derqvist&rsquo;s <code>nanbox</code> library</a> implements most of this bit-fiddling, so I may not have to  do it all myself. The downside of NaN-boxing is that in the 51-bit &ldquo;payload&rdquo; you can only store one pointer, so I can&rsquo;t implement two-pointer cons cells, or two-number complex values, or anything that requires more than 51 bits.</p>
<p>I&rsquo;m not sure what I&rsquo;m going to do with this all. Maybe I will write another scripting language. Maybe I&rsquo;ll find one. One of those two!</p>
        <hr />
        <p><strong>Related Posts</strong></p>
        <ul>
                <li><a href="https://dragoncoder047.github.io/blog/2024/pointer-soup">Pointer Soup</a></li>
                <li><a href="https://dragoncoder047.github.io/blog/2024/a-hash-mapped-mess">A Hash-Mapped Mess</a></li>
                <li><a href="https://dragoncoder047.github.io/blog/2024/the-lesser-of-two-evils">The Lesser of Two Evils</a></li>
                <li><a href="https://dragoncoder047.github.io/blog/2024/order-up">Order Up</a></li>
                <li><a href="https://dragoncoder047.github.io/blog/2023/continuations-and-the-thunk-queue">Continuations and the thunk queue</a></li>
        </ul>
    <script src="https://giscus.app/client.js"
        data-repo="dragoncoder047/blog"
        data-repo-id="R_kgDOHCL60w"
        data-category="Post Comments"
        data-category-id="DIC_kwDOHCL6084CRxCW"
        data-mapping="og:title"
        data-reactions-enabled="1"
        data-input-position="top"
        data-theme="dark"
        data-lang="en"
        crossorigin="anonymous"
        async
    ></script>
            <section id="extras">
                    <div class="blogroll">
                        <ul>
                                <li><a href="https://www.conwaylife.com/">Conwaylife.com Forums</a></li>
                                <li><a href="https://www.python.org/">Python</a></li>
                                <li><a href="http://www.ulisp.com/">uLisp</a></li>
                        </ul>
                    </div>
                    <div class="social">
                        <ul>
                                <li><a href="https://github.com/dragoncoder047">dragoncoder047 on GitHub</a></li>
                                <li><a href="https://youtube.com/@dragoncoder047">dragoncoder047 on YouTube</a></li>
                                <li><a href="https://instagram.com/dragoncoder047/">dragoncoder047 on Instagram</a></li>
                        </ul>
                    </div>
            </section>
        </main>
        <footer>
            <address>
                    Site built by <a href="https://getpelican.com/">Pelican</a>
            </address>
            <a href="#" onclick="window.scrollTo({top: 0, left: 0});">Back to top</a>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XR0F89CCGK"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() {
            dataLayer.push(arguments);
        }
        gtag("js", new Date());
        gtag("config", "G-XR0F89CCGK");
    </script>

        </footer>
    </body>
</html>