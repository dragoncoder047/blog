
<!DOCTYPE html>
<html lang="en_us">
    <head>
                <title>A Boost Converter</title>
            <meta charset="utf-8" />
            <meta name="generator" content="Pelican" />
            <meta name="viewport" content="width=device-width, initial-scale=1.0" />
            <link rel="stylesheet" href="/static/css/main.css" />
            <link rel="stylesheet" href="/static/css/theme.css" />
                    <link rel="icon" href="/images/patrick_head_silhouette.svg" type="image/svg+xml" />
                    <link rel="apple-touch-icon" href="/images/patrick_head_silhouette.svg" type="image/svg+xml" />
<script src="/static/misc.js"></script>


    


    <meta property="og:site_name" content="dragoncoder047&rsquo;s blog" />
    <meta property="og:title" content="A Boost Converter" />
    <meta property="og:description" content="The original Roboraptor had dual power supplies. Two “AA” size batteries supplied 3 volts for the logic circuitry, and four batteries in a separarte circuit provided 6 volts for the motors. My redesign of the Roboraptor is designed to run off of a large single-cell 3.7 volt lithium battery …" />
    <meta property="og:image" content="/images/patrick.svg" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://dragoncoder047.github.io/blog/post/2023-06-07-a-boost-converter.html" />
    <meta property="og:locale" content="['']" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="dragoncoder047&rsquo;s blog - A Boost Converter" />
    <meta name="twitter:description" content="The original Roboraptor had dual power supplies. Two “AA” size batteries supplied 3 volts for the logic circuitry, and four batteries in a separarte circuit provided 6 volts for the motors. My redesign of the Roboraptor is designed to run off of a large single-cell 3.7 volt lithium battery …" />
    <meta name="twitter:image" content="/images/patrick.svg" />
            <!-- Schemascii -->
<link rel="stylesheet" href="/schemascii/schemascii_example.css">        <!-- /Schemascii -->

    </head>

    <body class="match-braces rainbow-braces">
        <header>
                <a href="https://dragoncoder047.github.io/blog"><div class="flex-row"><img src="/images/patrick.svg" width="141" alt="Patrick the purple dragon" height="85" /><div id="sitename-text" class="flex-column"><h1>dragoncoder047&rsquo;s blog</h1><h2>random thoughts about nonrandom things</h2></div></div></a>
            <nav>
                <ul>
                    <li><a href="https://dragoncoder047.github.io/blog/">Home</a></li>
                        <li><a href="https://dragoncoder047.github.io/blog/archives.html">Archives</a>
                        </li>
                        <li><a href="/">Site root</a>
                        </li>
                        <li><a href="#">Projects</a>
                                <ul>
                                                            <li><a href="https://dragoncoder047.github.io/thuepaste">Thuepaste</a>
                        </li>
                        <li><a href="https://dragoncoder047.github.io/armdroid">Armdroid</a>
                        </li>
                        <li><a href="https://dragoncoder047.github.io/langton-music">Langton's Ant Music</a>
                        </li>
                        <li><a href="https://dragoncoder047.github.io/schemascii">Schemascii</a>
                        </li>

                                </ul>
                        </li>
                        <li><a href="https://dragoncoder047.github.io/blog/categories.html">Categories</a>
                            <ul>
                                    <li><a href="https://dragoncoder047.github.io/blog/category/cellular-automata.html">cellular automata</a></li>
                                    <li class="active"><a href="https://dragoncoder047.github.io/blog/category/electronics.html">electronics</a></li>
                                    <li><a href="https://dragoncoder047.github.io/blog/category/misc.html">misc</a></li>
                                    <li><a href="https://dragoncoder047.github.io/blog/category/programming.html">programming</a></li>
                                    <li><a href="https://dragoncoder047.github.io/blog/category/programming/c.html">programming/c</a></li>
                                    <li><a href="https://dragoncoder047.github.io/blog/category/programming/javascript.html">programming/javascript</a></li>
                                    <li><a href="https://dragoncoder047.github.io/blog/category/programming/lisp.html">programming/lisp</a></li>
                                    <li><a href="https://dragoncoder047.github.io/blog/category/programming/phoo.html">programming/phoo</a></li>
                                    <li><a href="https://dragoncoder047.github.io/blog/category/programming/python.html">programming/python</a></li>
                                    <li><a href="https://dragoncoder047.github.io/blog/category/robotics.html">robotics</a></li>
                                    <li><a href="https://dragoncoder047.github.io/blog/category/robotics/armdroid.html">robotics/armdroid</a></li>
                                    <li><a href="https://dragoncoder047.github.io/blog/category/robotics/reverse-engineering.html">robotics/reverse-engineering</a></li>
                            </ul>
                        </li>
                    <li>
                        <form action="https://www.google.com/search" method="GET">
                            <input name="q" type="search" placeholder="Search"></input>
                            <input type="hidden" name="as_sitesearch" value="https://dragoncoder047.github.io/blog"></input>
                            <input type="submit" value="Search"></input>
                        </form>
                    </li>
                </ul>
            </nav>
        </header>
        <main>
    <h1><a href="https://dragoncoder047.github.io/blog/post/2023-06-07-a-boost-converter.html" rel="bookmark" title="Permalink to this page">A Boost Converter</a></h1>
    
    <div class="flex-row">
            <span style="flex: 1">&larr; Previous:
                <a href="https://dragoncoder047.github.io/blog/post/2023-05-18-yet-another-garbage-collector.html">
                    Yet Another Garbage Collector
                </a>
            </span>
            <span>Next:
                <a href="https://dragoncoder047.github.io/blog/post/2023-07-02-powerful-pickle-pattern-matching.html">
                    Powerful PICKLE Pattern Matching
                </a> &rarr;
            </span>
    </div>
    <div class="post-info">
        Posted <time class="published" datetime="2023-06-07T00:00:00-04:00">Wed 07 June 2023</time>
            <address>By
                    <a href="https://dragoncoder047.github.io/blog/">dragoncoder047</a>
            </address>
                <div class="category">Category: <a href="https://dragoncoder047.github.io/blog/category/electronics.html">electronics</a></div>
    </div>
        <p><em>This post is part 5 of the roboraptor-upgrade series:</em></p>
        <ol class="series">
                <li >
                    <a href='https://dragoncoder047.github.io/blog/post/2022-07-18-shifting-gears.html'>Shifting Gears</a>
                </li>
                <li >
                    <a href='https://dragoncoder047.github.io/blog/post/2022-12-30-systems-tested.html'>Systems Tested</a>
                </li>
                <li >
                    <a href='https://dragoncoder047.github.io/blog/post/2023-01-17-hairy-circuit-layout-issues.html'>Hairy Circuit Layout Issues</a>
                </li>
                <li >
                    <a href='https://dragoncoder047.github.io/blog/post/2023-03-05-well-i-got-something.html'>Well, I Got Something...</a>
                </li>
                <li class="active">
                    <a href='https://dragoncoder047.github.io/blog/post/2023-06-07-a-boost-converter.html'>A Boost Converter</a>
                </li>
                <li >
                    <a href='https://dragoncoder047.github.io/blog/post/2023-07-23-error-out-of-memory.html'>Error: out of memory</a>
                </li>
        </ol>
    <p>The original Roboraptor had dual power supplies. Two &ldquo;AA&rdquo; size batteries supplied 3 volts for the logic circuitry, and four batteries in a separarte circuit provided 6 volts for the motors. My redesign of the Roboraptor is designed to run off of a large single-cell 3.7 volt lithium battery &ndash; but the motors run really sluggishly on only 3.7 volts (even though the torque is high as the battery can supply an incredible amount of current). So, to make the motors run faster, I need to increase the voltage.</p>
<p>Besides simply increasing the motor speeds, my idea includes a few more requirements:</p>
<ol>
<li>When the Roboraptor is in a &ldquo;sleep&rdquo; state, it can turn off the boost converter to save power.</li>
<li>It can artificially reduce the output voltage to make the motors move smoothly and minimize PWM whine at slow speeds.</li>
<li>It can monitor the output voltage and current to be able to automatically stop the motors if they are drawing too much current (and trigger a routine to make the robot act &ldquo;exhausted&rdquo;, perhaps).</li>
</ol>
<p>This all needs to be controllable in software. In an ideal world, something like this is already implemented and all I have to do is wire it up. Unfortunately, after hours of searhing on multiple sites, I could not find any boost converters that had both of these features. I did find <a href="https://www.pololu.com/product/2890">this boost converter from Polulu</a> that can be turned off using an enable signal, but this doesn&rsquo;t satisfy any of the other requirements without external current-sensing capabilities, not to mention the output voltage can&rsquo;t be adjusted in software, and it requires an extra GPIO pin for the enable signal (I&rsquo;m running low on pins!).</p>
<p>So I figured I would have to make one using a microcontroller, and read data and send commands to it over I2C. I first looked up how a boost converter works. It&rsquo;s pretty simple, and I even found <a href="https://www.youtube.com/watch?v=QnUhjnbZ0T8">this video</a> by Great Scott that even implements a boost converter using an ATtiny85 &ndash; the same microcontroller I am using for peripheral tasks elsewhere in the robot. This is the circuit I settled on:</p>
<p><svg width="1170" height="240" viewBox="-30 -30 1170 240" xmlns="http://www.w3.org/2000/svg" class="schemascii"><g class="wire"><polyline points="210,60 225,60 225,0 30,0" stroke="black" stroke-width="2"></polyline><polyline points="255,0 225,0" stroke="black" stroke-width="2"></polyline></g><g class="wire"><polyline points="345,60 345,0 300,0" stroke="black" stroke-width="2"></polyline><polyline points="405,0 345,0" stroke="black" stroke-width="2"></polyline></g><g class="wire"><polyline points="480,90 480,0 450,0" stroke="black" stroke-width="2"></polyline><polyline points="450,75 480,75" stroke="black" stroke-width="2"></polyline><polyline points="540,0 480,0" stroke="black" stroke-width="2"></polyline></g><g class="wire"><polyline points="405,75 390,75 390,135 60,135 60,75 105,75" stroke="black" stroke-width="2"></polyline><polyline points="405,135 390,135" stroke="black" stroke-width="2"></polyline></g><g class="wire"><polyline points="225,75 210,75" stroke="black" stroke-width="2"></polyline></g><g class="wire"><polyline points="210,90 300,90 300,75 315,75" stroke="black" stroke-width="2"></polyline></g><g class="wire"><polyline points="30,150 30,105 105,105" stroke="black" stroke-width="2"></polyline></g><g class="wire"><polyline points="225,105 210,105" stroke="black" stroke-width="2"></polyline></g><g class="wire"><polyline points="345,90 345,150" stroke="black" stroke-width="2"></polyline></g><g class="wire"><polyline points="480,150 480,120" stroke="black" stroke-width="2"></polyline><polyline points="450,135 480,135" stroke="black" stroke-width="2"></polyline></g><g class="component U"><rect x="120" y="45" width="75" height="75" stroke-width="2" stroke="black" fill="transparent"></rect><polyline points="210,60 195,60" stroke="black" stroke-width="2"></polyline><polyline points="210,75 195,75" stroke="black" stroke-width="2"></polyline><polyline points="210,90 195,90" stroke="black" stroke-width="2"></polyline><polyline points="210,105 195,105" stroke="black" stroke-width="2"></polyline><polyline points="105,60 120,60" stroke="black" stroke-width="2"></polyline><polyline points="105,75 120,75" stroke="black" stroke-width="2"></polyline><polyline points="105,90 120,90" stroke="black" stroke-width="2"></polyline><polyline points="105,105 120,105" stroke="black" stroke-width="2"></polyline><text x="157.5" y="82.5" text-anchor="middle" font-size="15" fill="black"><tspan class="part-num">ATtiny85</tspan></text><text x="157.5" y="67.5" text-anchor="middle" font-size="15" fill="black"><tspan class="cmp-id">U1</tspan></text><text x="105" y="60" text-anchor="middle" font-size="15" fill="black" class="pin-label"></text><text x="105" y="75" text-anchor="middle" font-size="15" fill="black" class="pin-label">PB3</text><text x="105" y="90" text-anchor="middle" font-size="15" fill="black" class="pin-label"></text><text x="105" y="105" text-anchor="middle" font-size="15" fill="black" class="pin-label">GND</text><text x="210" y="105" text-anchor="middle" font-size="15" fill="black" class="pin-label">PB0</text><text x="210" y="90" text-anchor="middle" font-size="15" fill="black" class="pin-label">PB1</text><text x="210" y="75" text-anchor="middle" font-size="15" fill="black" class="pin-label">PB2</text><text x="210" y="60" text-anchor="middle" font-size="15" fill="black" class="pin-label">VCC</text></g><g class="component J"><polyline points="15,1.84e-15 30,0 23.93,4.41" stroke="black" stroke-width="2"></polyline><polyline points="30,0 23.93,-4.41" stroke="black" stroke-width="2"></polyline><text x="7.5" y="0.0" text-anchor="start" font-size="15" fill="black"><tspan class="cmp-id">J1</tspan> <tspan class="part-num">Vin</tspan></text></g><g class="component L"><path d="M300 0a1 1 0 01 -15 0a1 1 0 01 -15 0a1 1 0 01 -15 0" stroke="black" fill="transparent" stroke-width="2"></path><text x="277.5" y="-7.5" text-anchor="middle" font-size="15" fill="black"><tspan class="cmp-id">L1</tspan> <tspan class="cmp-value">220 µH</tspan></text></g><g class="component D"><text x="427.5" y="-7.5" text-anchor="middle" font-size="15" fill="black"><tspan class="cmp-id">D1</tspan> <tspan class="part-num">SB360</tspan></text><polyline points="432,4.5 432,-4.5" stroke="black" stroke-width="2"></polyline><polyline points="405,0 432,-5.51e-16" stroke="black" stroke-width="2"></polyline><polyline points="450,0 423,5.51e-16" stroke="black" stroke-width="2"></polyline><polygon points="432,-5.51e-16 423,-4.5 423,4.5" fill="black" class="filled"></polygon></g><g class="component J"><polyline points="540,0 555,0 548.93,4.41" stroke="black" stroke-width="2"></polyline><polyline points="555,0 548.93,-4.41" stroke="black" stroke-width="2"></polyline><text x="562.5" y="0" text-anchor="start" font-size="15" fill="black"><tspan class="cmp-id">J2</tspan> <tspan class="part-num">Vout</tspan></text></g><g class="component J"><polyline points="225,75 240,75 233.93,79.41" stroke="black" stroke-width="2"></polyline><polyline points="240,75 233.93,70.59" stroke="black" stroke-width="2"></polyline><text x="247.5" y="75" text-anchor="start" font-size="15" fill="black"><tspan class="cmp-id">J4</tspan> <tspan class="part-num">SCL</tspan></text></g><g class="component Q"><text x="352.5" y="75" text-anchor="start" font-size="15" fill="black"><tspan class="cmp-id">Q1</tspan> <tspan class="part-num">IRL2703</tspan></text><polyline points="330,75 315,75" stroke="black" stroke-width="2"></polyline><polyline points="330,82.5 330,67.5" stroke="black" stroke-width="2"></polyline><polyline points="334.5,90 334.5,60" stroke="black" stroke-width="2"></polyline><polyline points="345,60 345,63 334.5,63" stroke="black" stroke-width="2"></polyline><polyline points="345,90 345,87 338.93,91.41" stroke="black" stroke-width="2"></polyline><polyline points="334.5,87 345,87 338.93,82.59" stroke="black" stroke-width="2"></polyline></g><g class="component R"><polyline points="450,75 446.25,71.25 442.5,78.75 438.75,71.25 435,78.75 431.25,71.25 427.5,78.75 423.75,71.25 420,78.75 416.25,71.25 412.5,78.75 408.75,71.25 405,75" fill="transparent" stroke-width="2" stroke="black"></polyline><text x="427.5" y="67.5" text-anchor="middle" font-size="15" fill="black"><tspan class="cmp-id">R1</tspan> <tspan class="cmp-value">100 kΩ</tspan></text></g><g class="component J"><polyline points="225,105 240,105 233.93,109.41" stroke="black" stroke-width="2"></polyline><polyline points="240,105 233.93,100.59" stroke="black" stroke-width="2"></polyline><text x="247.5" y="105" text-anchor="start" font-size="15" fill="black"><tspan class="cmp-id">J3</tspan> <tspan class="part-num">SDA</tspan></text></g><g class="component C"><polyline points="486,108.75 474,108.75" stroke="black" stroke-width="2"></polyline><polyline points="486,101.25 474,101.25" stroke="black" stroke-width="2"></polyline><polyline points="480,120 480,108.75" stroke="black" stroke-width="2"></polyline><polyline points="480,90 480,101.25" stroke="black" stroke-width="2"></polyline><g class="plus"><polyline points="483.07,93.75 486.82,93.75" stroke="black" stroke-width="2"></polyline><polyline points="484.95,95.62 484.95,91.88" stroke="black" stroke-width="2"></polyline></g><text x="487.5" y="105" text-anchor="start" font-size="15" fill="black"><tspan class="cmp-id">C1</tspan> <tspan class="cmp-value">68 µF</tspan></text></g><g class="component R"><polyline points="450,135 446.25,131.25 442.5,138.75 438.75,131.25 435,138.75 431.25,131.25 427.5,138.75 423.75,131.25 420,138.75 416.25,131.25 412.5,138.75 408.75,131.25 405,135" fill="transparent" stroke-width="2" stroke="black"></polyline><text x="427.5" y="127.5" text-anchor="middle" font-size="15" fill="black"><tspan class="cmp-id">R2</tspan> <tspan class="cmp-value">10 kΩ</tspan></text></g><g class="component G"><polyline points="33.75,172.5 37.5,165 22.5,165 18.75,172.5" stroke="black" stroke-width="2"></polyline><polyline points="30,150 30,165 26.25,172.5" stroke="black" stroke-width="2"></polyline></g><g class="component G"><polyline points="348.75,172.5 352.5,165 337.5,165 333.75,172.5" stroke="black" stroke-width="2"></polyline><polyline points="345,150 345,165 341.25,172.5" stroke="black" stroke-width="2"></polyline></g><g class="component G"><polyline points="483.75,172.5 487.5,165 472.5,165 468.75,172.5" stroke="black" stroke-width="2"></polyline><polyline points="480,150 480,165 476.25,172.5" stroke="black" stroke-width="2"></polyline></g></svg></p>
<p>GreatScott&rsquo;s code is the bare-bones necessary for a boost converter: it simply monitors an ADC input, which is connected to the output through a resistor divider, and adjusts the PWM duty cycle on another pin controlling the transistor to keep the output voltage steady at the set point (voltage too high = reduce duty cycle; too low = increase duty cycle). In his video, is controlled by another ADC input connected to a potentiometer knob, but I&rsquo;ll be changing it over I2C.</p>
<p><a href="https://dragoncoder047.github.io/blog/post/2023-03-05-well-i-got-something.html">Previously</a> I found <a href="https://github.com/rambo/TinyWire">this library</a> that allows the ATtiny85 to show up as an I2C slave device, and tested it out communicating with my ESP32 (no boost converter code yet). It worked-ish, but some subsequent testing (after that post) revealed that the ESP32 has a nasty silicon bug where it does not tolerate clock stretching (the ATtiny85 clock-stretches extensively because it runs so slow), causing batch reads to fail. Fortunately, there are software workarounds.</p>
<h2 id="integration-hell">Integration hell</h2>
<p>After confirming the I2C code worked, I installed the boost converter code into the ATtiny85 and connected it to the circuit. For comparison purposes I connected a wire to the ATtiny85&rsquo;s reset pin, preventing it from running. The motor only saw the 3.3 volts coming from the regulator, and it ran sluggishly, as expected. When I unplugged the reset wire to turn on the boost converter, the motor quickly gained speed until it stabilized at about twice the 3.3V speed &ndash; indicating that my boost converter is at least working doing that.</p>
<p>Then I tried to change the output voltage over I2C. Now the ATtiny85 didn&rsquo;t even ACK on its own address!</p>
<p>I figured that maybe the interrupts I was using to synchronize the ADC and the PWM signal were causing an issue, so I moved all the code for that out of the interrupt routines and put it in the main loop, so that it would be pre-empted by the I2C interrupt. Still not working&hellip; maybe it&rsquo;s running too much code to be able to quickly handle the I2C interrupts fast enough? I&rsquo;ll need to do some more debugging.</p>
    <script src="https://giscus.app/client.js"
        data-repo="dragoncoder047/blog"
        data-repo-id="R_kgDOHCL60w"
        data-category="Post Comments"
        data-category-id="DIC_kwDOHCL6084CRxCW"
        data-mapping="og:title"
        data-reactions-enabled="1"
        data-input-position="top"
        data-theme="dark"
        data-lang="en"
        crossorigin="anonymous"
        async
    ></script>
            <section id="extras">
                    <div class="blogroll">
                        <ul>
                                <li><a href="https://www.conwaylife.com/">Conwaylife</a></li>
                                <li><a href="https://www.python.org/">Python</a></li>
                        </ul>
                    </div>
                    <div class="social">
                        <ul>

                                <li><a href="https://github.com/dragoncoder047">dragoncoder047 on GitHub</a></li>
                        </ul>
                    </div>
            </section>
        </main>
        <footer>
            <address>
                    Site built by <a href="https://getpelican.com/">Pelican</a>
            </address>
            <a href="#" onclick="window.scrollTo({top: 0, left: 0});">Back to top</a>
        </footer>
    </body>
</html>