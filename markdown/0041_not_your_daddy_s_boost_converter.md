Title: Not Your Daddy's Boost Converter
Date: 2023-06-07
Modified: 2024-04-08
Series: roboraptor-upgrade
Tags: electronics, youtube

The original Roboraptor had dual power supplies. Two "AA" size batteries supplied 3 volts for the logic circuitry, and four batteries in a separarte circuit provided 6 volts for the motors. My redesign of the Roboraptor is designed to run off of a large single-cell 3.7 volt lithium battery -- but the motors run really sluggishly on only 3.7 volts (even though the torque is high as the battery can supply an incredible amount of current). So, to make the motors run faster, I need to increase the voltage.

<youtube id="NnDvN9RbQGY?si=ahxCAqWVCsQAkOef">

On top of that, my idea includes a few more requirements:

1. When the Roboraptor is in a "sleep" state, it can turn off the boost converter to save power.
2. It can artificially reduce the output voltage to make the motors move smoothly and minimize PWM whine at slow speeds.
3. It can monitor the output voltage and current to be able to automatically stop the motors if they are drawing too much current (and trigger a routine to make the robot act "exhausted", perhaps).

This all needs to be controllable in software. In an ideal world, something like this is already implemented and all I have to do is wire it up. Unfortunately, after hours of searhing on multiple sites, I could not find any boost converters that had both of these features. I did find [this boost converter from Polulu](https://www.pololu.com/product/2890) that can be turned off using an enable signal, but this doesn't satisfy any of the other requirements without external current-sensing capabilities, not to mention the output voltage can't be adjusted in software, and it requires an extra GPIO pin for the enable signal (I'm running low on pins!).

So I figured I would have to make one using a microcontroller, and read data and send commands to it over I2C. I first looked up how a boost converter works. It's pretty simple, and I even found [this video](https://www.youtube.com/watch?v=QnUhjnbZ0T8) by Great Scott that even implements a boost converter using an ATtiny85 -- the same microcontroller I am using for peripheral tasks elsewhere in the robot. This is the circuit I settled on:

<p><svg width="870" height="285" viewBox="-30 -30 870 285" xmlns="http://www.w3.org/2000/svg" class="schemascii"><g class="wire"><polyline points="210,105 225,105 225,15" fill="transparent" stroke-width="2" stroke="black"></polyline><polyline points="255,45 225,45" fill="transparent" stroke-width="2" stroke="black"></polyline></g><g class="wire"><polyline points="375,105 375,45 345,45" fill="transparent" stroke-width="2" stroke="black"></polyline><polyline points="420,45 375,45" fill="transparent" stroke-width="2" stroke="black"></polyline></g><g class="wire"><polyline points="555,90 555,45 465,45" fill="transparent" stroke-width="2" stroke="black"></polyline><polyline points="600,45 555,45" fill="transparent" stroke-width="2" stroke="black"></polyline><polyline points="495,75 495,45" fill="transparent" stroke-width="2" stroke="black"></polyline></g><g class="wire"><polyline points="555,120 555,150 420,150 420,210 30,210 30,120 105,120" fill="transparent" stroke-width="2" stroke="black"></polyline><polyline points="555,165 555,150" fill="transparent" stroke-width="2" stroke="black"></polyline></g><g class="wire"><polyline points="225,120 210,120" fill="transparent" stroke-width="2" stroke="black"></polyline></g><g class="wire"><polyline points="210,135 330,135 330,120 345,120" fill="transparent" stroke-width="2" stroke="black"></polyline></g><g class="wire"><polyline points="75,165 75,150 105,150" fill="transparent" stroke-width="2" stroke="black"></polyline></g><g class="wire"><polyline points="225,150 210,150" fill="transparent" stroke-width="2" stroke="black"></polyline></g><g class="component U"><rect x="120" y="90" width="75" height="75" stroke-width="2" stroke="black" fill="transparent"></rect><polyline points="210,105 195,105" fill="transparent" stroke-width="2" stroke="black"></polyline><polyline points="210,120 195,120" fill="transparent" stroke-width="2" stroke="black"></polyline><polyline points="210,135 195,135" fill="transparent" stroke-width="2" stroke="black"></polyline><polyline points="210,150 195,150" fill="transparent" stroke-width="2" stroke="black"></polyline><polyline points="105,105 120,105" fill="transparent" stroke-width="2" stroke="black"></polyline><polyline points="105,120 120,120" fill="transparent" stroke-width="2" stroke="black"></polyline><polyline points="105,135 120,135" fill="transparent" stroke-width="2" stroke="black"></polyline><polyline points="105,150 120,150" fill="transparent" stroke-width="2" stroke="black"></polyline><text x="157.5" y="127.5" text-anchor="middle" font-size="15" fill="black"><tspan class="part-num">ATtiny85</tspan></text><text x="157.5" y="112.5" text-anchor="middle" font-size="15" fill="black"><tspan class="cmp-id">U1</tspan></text><text x="105" y="105" text-anchor="middle" font-size="15" fill="black" class="pin-label"></text><text x="105" y="120" text-anchor="middle" font-size="15" fill="black" class="pin-label">PB3</text><text x="105" y="135" text-anchor="middle" font-size="15" fill="black" class="pin-label"></text><text x="105" y="150" text-anchor="middle" font-size="15" fill="black" class="pin-label">GND</text><text x="210" y="150" text-anchor="middle" font-size="15" fill="black" class="pin-label">PB0</text><text x="210" y="135" text-anchor="middle" font-size="15" fill="black" class="pin-label">PB1</text><text x="210" y="120" text-anchor="middle" font-size="15" fill="black" class="pin-label">PB2</text><text x="210" y="105" text-anchor="middle" font-size="15" fill="black" class="pin-label">VCC</text></g><g class="component J"><polyline points="225,0 225,15 220.59,8.93" fill="transparent" stroke-width="2" stroke="black"></polyline><polyline points="225,15 229.41,8.93" fill="transparent" stroke-width="2" stroke="black"></polyline><text x="225" y="-7.5" text-anchor="middle" font-size="15" fill="black"><tspan class="cmp-id">J1</tspan> <tspan class="part-num">Vin</tspan></text></g><g class="component L"><path d="M345.0 45.0a1 1 0 01 -15 0.0a1 1 0 01 -15 0.0a1 1 0 01 -15 0.0a1 1 0 01 -15 0.0a1 1 0 01 -15 0.0a1 1 0 01 -15 0" stroke="black" fill="transparent" stroke-width="2"></path><text x="300" y="37.5" text-anchor="middle" font-size="15" fill="black"><tspan class="cmp-id">L1</tspan> <tspan class="cmp-value">220 µH</tspan></text></g><g class="component D"><text x="442.5" y="37.5" text-anchor="middle" font-size="15" fill="black"><tspan class="cmp-id">D1</tspan> <tspan class="part-num">SB360</tspan></text><polyline points="447,49.5 447,40.5" fill="transparent" stroke-width="2" stroke="black"></polyline><polyline points="420,45 447,45" fill="transparent" stroke-width="2" stroke="black"></polyline><polyline points="465,45 438,45" fill="transparent" stroke-width="2" stroke="black"></polyline><polygon points="447,45 438,40.5 438,49.5" fill="black" class="filled"></polygon></g><g class="component J"><polyline points="600,45 615,45 608.93,49.41" fill="transparent" stroke-width="2" stroke="black"></polyline><polyline points="615,45 608.93,40.59" fill="transparent" stroke-width="2" stroke="black"></polyline><text x="622.5" y="45" text-anchor="start" font-size="15" fill="black"><tspan class="cmp-id">J2</tspan> <tspan class="part-num">Vout</tspan></text></g><g class="component C"><polyline points="501,93.75 489,93.75" fill="transparent" stroke-width="2" stroke="black"></polyline><polyline points="501,86.25 489,86.25" fill="transparent" stroke-width="2" stroke="black"></polyline><polyline points="495,105 495,93.75" fill="transparent" stroke-width="2" stroke="black"></polyline><polyline points="495,75 495,86.25" fill="transparent" stroke-width="2" stroke="black"></polyline><g class="plus"><polyline points="498.07,78.75 501.82,78.75" fill="transparent" stroke-width="2" stroke="black"></polyline><polyline points="499.95,80.62 499.95,76.88" fill="transparent" stroke-width="2" stroke="black"></polyline></g><text x="502.5" y="90" text-anchor="start" font-size="15" fill="black"><tspan class="cmp-id">C1</tspan> <tspan class="cmp-value">1000 µF</tspan></text></g><g class="component R"><polyline points="555,90 551.25,93.75 558.75,97.5 551.25,101.25 558.75,105 551.25,108.75 558.75,112.5 551.25,116.25 555,120" fill="transparent" stroke-width="2" stroke="black"></polyline><text x="562.5" y="105" text-anchor="start" font-size="15" fill="black"><tspan class="cmp-id">R1</tspan> <tspan class="cmp-value">100 kΩ</tspan></text></g><g class="component J"><polyline points="225,120 240,120 233.93,124.41" fill="transparent" stroke-width="2" stroke="black"></polyline><polyline points="240,120 233.93,115.59" fill="transparent" stroke-width="2" stroke="black"></polyline><text x="247.5" y="120" text-anchor="start" font-size="15" fill="black"><tspan class="cmp-id">J4</tspan> <tspan class="part-num">SCL</tspan></text></g><g class="component Q"><text x="382.5" y="120" text-anchor="start" font-size="15" fill="black"><tspan class="cmp-id">Q1</tspan> <tspan class="part-num">IRLZ44N</tspan></text><polyline points="360,120 345,120" fill="transparent" stroke-width="2" stroke="black"></polyline><polyline points="360,127.5 360,112.5" fill="transparent" stroke-width="2" stroke="black"></polyline><polyline points="364.5,135 364.5,105" fill="transparent" stroke-width="2" stroke="black"></polyline><polyline points="375,105 375,108 364.5,108" fill="transparent" stroke-width="2" stroke="black"></polyline><polyline points="375,135 375,132 368.93,136.41" fill="transparent" stroke-width="2" stroke="black"></polyline><polyline points="364.5,132 375,132 368.93,127.59" fill="transparent" stroke-width="2" stroke="black"></polyline></g><g class="component G"><polyline points="498.75,127.5 502.5,120 487.5,120 483.75,127.5" fill="transparent" stroke-width="2" stroke="black"></polyline><polyline points="495,105 495,120 491.25,127.5" fill="transparent" stroke-width="2" stroke="black"></polyline></g><g class="component J"><polyline points="225,150 240,150 233.93,154.41" fill="transparent" stroke-width="2" stroke="black"></polyline><polyline points="240,150 233.93,145.59" fill="transparent" stroke-width="2" stroke="black"></polyline><text x="247.5" y="150" text-anchor="start" font-size="15" fill="black"><tspan class="cmp-id">J3</tspan> <tspan class="part-num">SDA</tspan></text></g><g class="component G"><polyline points="378.75,157.5 382.5,150 367.5,150 363.75,157.5" fill="transparent" stroke-width="2" stroke="black"></polyline><polyline points="375,135 375,150 371.25,157.5" fill="transparent" stroke-width="2" stroke="black"></polyline></g><g class="component G"><polyline points="78.75,187.5 82.5,180 67.5,180 63.75,187.5" fill="transparent" stroke-width="2" stroke="black"></polyline><polyline points="75,165 75,180 71.25,187.5" fill="transparent" stroke-width="2" stroke="black"></polyline></g><g class="component R"><polyline points="555,165 551.25,168.75 558.75,172.5 551.25,176.25 558.75,180 551.25,183.75 558.75,187.5 551.25,191.25 555,195" fill="transparent" stroke-width="2" stroke="black"></polyline><text x="562.5" y="180" text-anchor="start" font-size="15" fill="black"><tspan class="cmp-id">R2</tspan> <tspan class="cmp-value">10 kΩ</tspan></text></g><g class="component G"><polyline points="558.75,217.5 562.5,210 547.5,210 543.75,217.5" fill="transparent" stroke-width="2" stroke="black"></polyline><polyline points="555,195 555,210 551.25,217.5" fill="transparent" stroke-width="2" stroke="black"></polyline></g></svg></p>

GreatScott's code is the bare-bones necessary for a boost converter: it simply monitors an ADC input, which is connected to the output through a resistor divider, and adjusts the PWM duty cycle on another pin controlling the transistor to keep the output voltage steady at the set point (voltage too high = reduce duty cycle; too low = increase duty cycle). In his video, the setpoint is controlled by another ADC input connected to a potentiometer knob, but I'll be changing it over I2C.

[Previously]({filename}0035_well_i_got_something.md) I found [this library](https://github.com/rambo/TinyWire) that allows the ATtiny85 to show up as an I2C slave device, and tested it out communicating with my ESP32 (no boost converter code yet). It worked-ish, but some subsequent testing (after that post) revealed that ~~the ESP32 has a nasty silicon bug where it does not tolerate clock stretching (the ATtiny85 clock-stretches extensively because it runs so slow), causing batch reads to fail~~. Fortunately, there are software workarounds. EDIT -- such as *fixing my own code*. I was helped a lot in this regard by switching to Spence Konde's [ATTinyCore](https://github.com/SpenceKonde/ATTinyCore/), which includes a built-in fork of the TinyWire library linked above as well as extensive documentation.

## Integration, hell and back

After confirming the I2C code worked, I installed the boost converter code into the ATtiny85 and connected it to the circuit. For comparison purposes I connected a wire to the ATtiny85's reset pin, preventing it from running. The motor only saw the 3.3 volts coming from the regulator, and it ran sluggishly, as expected. When I unplugged the reset wire to turn on the boost converter, the motor quickly gained speed until it stabilized at about twice the 3.3V speed -- indicating that my boost converter is at least working doing that.

Then I tried to change the output voltage over I2C. Now the ATtiny85 didn't even ACK on its own address!

After a *lot* of debugging, a [month-long rabbit hole](https://github.com/technoblogy/ulisp-esp/issues/75) trying to figure out why reads didn't work, and finding out I was using several outdated packages (and updating), I finally, at long last, got the voltage to change by sending commands over I2C. Whew!!

The [code used is on GitHub](https://github.com/dragoncoder047/super85/tree/master/smartboost). And the circuit is above.
